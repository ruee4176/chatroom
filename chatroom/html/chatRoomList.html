<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- WEB CSS -->

    <!-- CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/chat/list.css">
    <link rel="stylesheet" href="css/chat/modal.css">
    <link rel="stylesheet" href="css/chat/room.css">

    <!-- WEB JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
    <script src="https://kit.fontawesome.com/c4e734c793.js" crossorigin="anonymous"></script>

    

</head>

<body>
    <div class="list-wrap br4 shadow">
        <div class="flex" style="width: 100%; height: 100%; position: relative;">
            <div class="list-left flex flex-justify flex-column">
                <div>
                    <div>
                        <div class="list-icon-wrap">
                            <i class="fas fa-comment list-icon" name="chat-list" onclick="roomCodeCheck(prompt('입장할 방의 코드를 입력하세요.'))"></i>
                            <span class="list-icon-pop-text">채팅</span>
                        </div>
                        <div class="list-icon-wrap">
                            <i class="fas fa-comment-medical list-icon" name="chat-list" onclick="modalCreate()"></i>
                            <span class="list-icon-pop-text">채팅방 생성</span>
                        </div>
                    </div>
                </div>
                <div>
                    <div>
                        <div class="list-icon-wrap">
                            <i class="fas fa-cog list-icon" name="setting" onclick="modalSetting()"></i>
                            <span class="list-icon-pop-text">설정</span>
                        </div>
                        <div class="list-icon-wrap">
                            <i class="fas fa-sign-out-alt list-icon" name="logout-icon" onclick="logout(confirm('정말 로그아웃 하시겠습니까?'))"></i>
                            <span class="list-icon-pop-text">로그아웃</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="list-right">
                <div>
                    <div>
                        <div>
                            <!-- 최상단 -->
                        </div>
                        <div class="list-top">
                            <i class="fas fa-cloud-moon" style="font-size: 24px;"></i>
                            <h1 class="raleway" style="font-size: 34px; font-weight: 700;">
                                PHY
                            </h1>
                            <h3 class="roboto" style="font-size: 18px;">Chat</h1>
                        </div>
                    </div>

                    <div class="list-main">
                        <!-- 채팅방 목록 뜨는곳. -->
                        <div class="room-wrap flex" ondblclick="roomOpen()">
                            <div class="room-icon-wrap flex">
                                <div class="room-icon">
                                    <img class="pointer" src="images/free-icon-human-106137.png" alt="">
                                </div>
                            </div>
                            <div class="room-info-wrap flex flex-column">
                                <div class="room-info">
                                    <div style="width: 100%;">
                                        <div class="room-info-title">
                                            <span>개발팀 채팅방
                                            </span>
                                        </div>
                                        <div class="room-info-lastchat">
                                            <span>
                                                    자택근무 확인서.pdf
                                                </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="room-alram flex flex-column">
                                <div class="room-alram-time">
                                    <span>
                                            오후 13:39
                                    </span>
                                </div>
                                <div class="room-alram-misscnt">
                                    <span class="numberCircle ">
                                            <span>11</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- //채팅방 목록 뜨는곳. -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달창 - 채팅방 입장 -->
    <div class="modal" id="modal-join" onclick="modalJoin()"> 
        <div class="modal-box">
            <div class="room-register shadow" onclick="noBubbling(event)">
                <div>
                    <div>
                        <div class="modal-close">
                            <span onclick="modalJoin()">X</span>
                        </div>
                    </div>
                    <div>
                        <div class="list-top" style="margin: 0 60px;">
                            <h2 class="modal-title" style="font-size: 20px;">채팅방 입장</h2>
                        </div>
                    </div>
                </div>
                <div>
                    <form class="" id="join-form" method="POST" action="" autocomplete="off">
                        <div class="input-box">
                            <div class="flex" style="align-items: center;">
                                <input type="text" name="room_code" id="room_code" readonly placeholder="채팅방 코드" maxlength="20"/>
                            </div>
                            <div class="flex" id="join-pwd" style="align-items: center; display: none;">
                                <input type="text" name="room_pwd" id="room_pwd" placeholder="채팅방 비밀번호" maxlength="20" />
                                <button type="button" class="btn-normal-v m5" onclick="roomPwdCheck(this)">암호 확인</button>
                            </div>
                            <input type="text" name="room_title" id="room_title" readonly placeholder="채팅방 이름" maxlength="20"/>
                            <input type="text" name="" id="" readonly placeholder="채팅방 정보" maxlength="30"/>
                            <div class="flex" style="justify-content: flex-end; margin-top: 20px; margin-right: 80px;">
                                <button type="submit" id="join-btn" class="btn-on m5">입장</button>
                                <button type="button" class="btn-off m5" onclick="modalJoin()">취소</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달창 - 채팅방 생성 -->
    <div class="modal" id="modal-create" onclick="modalCreate()"> 
        <div class="modal-box">
            <div class="room-register shadow" onclick="noBubbling(event)">
                <div>
                    <div>
                        <div class="modal-close">
                            <span onclick="modalCreate()">X</span>
                        </div>
                    </div>
                    <div>
                        <div class="list-top" style="margin: 0 60px;">
                            <h2 class="modal-title" style="font-size: 20px;">채팅방 생성</h2>
                        </div>
                    </div>
                </div>
                <div>
                    <form id="frm" method="POST" action="" autocomplete="off">
                        <div class="input-box">
                            <input type="text" name="room_title" id="room_title" placeholder="채팅방 이름" maxlength="20"/>
                            <div class="flex" style="align-items: center;">
                                <input type="text" name="room_pwd" id="room_pwd" class="off" placeholder="채팅방 비밀번호" disabled maxlength="20"/>
                                <input type="checkbox" class="m5" onchange="pwd_on(this)"/>비밀방
                            </div>
                            <div class="flex" style="align-items: center;">
                                <input type="text" name="room_code" id="room_code" class="off" readonly placeholder="채팅방 코드" disabled maxlength="20"/>
                                <button type="button" class="btn-normal-v m5" onclick="getRoomCode(this)">코드 생성</button>
                            </div>
                            <input type="text" name="" id="" placeholder="채팅방 정보" maxlength="30"/>
                            <div class="flex" style="justify-content: flex-end; margin-top: 20px; margin-right: 80px;">
                                <button type="submit" class="btn-on m5">생성</button>
                                <button type="button" class="btn-off m5" onclick="modalCreate()">취소</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달창 - 설정 -->
    <div class="modal" id="modal-setting" onclick="modalSetting()"> 
        <div class="modal-box">
            <div class="room-register shadow" onclick="noBubbling(event)">
                <div>
                    <div>
                        <div class="modal-close">
                            <span onclick="modalSetting()">X</span>
                        </div>
                    </div>
                    <div>
                        <div class="list-top" style="margin: 0 60px;">
                            <h2 class="modal-title" style="font-size: 20px;">프로필 설정</h2>
                        </div>
                    </div>
                </div>
                <div>
                    <form id="upMember" method="POST" action="" autocomplete="off">
                        <div class="input-box">
                            <input type="text" name="mem_num" id="mem_num" placeholder="아이디" maxlength="20"/>
                            <input type="text" name="mem_pwd" id="mem_pwd" placeholder="비밀번호" maxlength="20"/>
                            <input type="text" name="mem_name" id="mem_name" placeholder="이름" maxlength="20"/>
                            <input type="text" name="mem_buseo" id="mem_buseo" placeholder="부서" maxlength="4"/>
                            <input type="text" name="mem_grade" id="mem_grade" placeholder="직급" maxlength="4"/>
                            <input type="text" name="mem_auth" id="mem_auth" placeholder="권한" maxlength="4"/>
                            <div class="flex" style="justify-content: flex-end; margin-top: 20px; margin-right: 80px;">
                                <button type="submit" class="btn-on m5">수정</button>
                                <button type="button" class="btn-off m5" onclick="modalSetting()">취소</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달창 - 방 설정 -->
    <div class="modal" id="modal-room-setting" onclick="modalRoomSetting()"> 
        <div class="modal-box">
            <div class="room-register shadow" onclick="noBubbling(event)">
                <div>
                    <div>
                        <div class="modal-close">
                            <span onclick="modalRoomSetting()">X</span>
                        </div>
                    </div>
                    <div>
                        <div class="list-top" style="margin: 0 60px;">
                            <h2 class="modal-title" style="font-size: 20px;">프로필 설정</h2>
                        </div>
                    </div>
                </div>
                <div>
                    <form id="frm" method="POST" action="" autocomplete="off">
                        <div class="input-box">
                            <input type="hidden" name="room_title" id="room_title" placeholder="방 제목" maxlength="20" value="title"/>
                            <div class="flex" style="align-items: center;">
                                <input type="text" name="room_code" id="room_code" class="off" readonly placeholder="채팅방 코드" value="code"  maxlength="20"/>
                                <button type="button" class="btn-normal-v m5" onclick="getRoomCode(this)">코드 생성</button>
                            </div>
                            <div class="flex" style="align-items: center;">
                                <input type="text" name="room_pwd" id="room_pwd" class="off" placeholder="채팅방 비밀번호" value="pwd" disabled maxlength="20"/>
                                <input type="checkbox" class="m5" onchange="pwd_on(this)"/>비밀방
                            </div>
                            <input type="text" name="host_id" id="host_id" placeholder="호스트" maxlength="4"/>
                            <input type="text" name="room_info" id="room_info" placeholder="방 정보" maxlength="4"/>
                            <div class="flex" style="justify-content: flex-end; margin-top: 20px; margin-right: 80px;">
                                <button type="submit" class="btn-on m5">수정</button>
                                <button type="button" class="btn-off m5" onclick="modalRoomSetting()">취소</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- //모달창-->

    <!-- 모달창 - 채팅방 -->
    <div class="chat-wrap br4 shadow flex flex-justify">
        <div class="chat-box">
            <div class="chat-top flex">
                <div class="chat-room-icon m-t5" style="width: 20%;">
                    <div class="chat-icon">
                        <img src="images/free-icon-human-106137.png" alt="" onclick="">
                    </div>
                </div>
                <div class="chat-title m-t10" style="width: 70%;">
                    <h3 class="chat-room-title" name="chat-room-title">채팅방 이름</h3>
                </div>
                <div class="chat-title" style="width: 10%; ">
                    <div class="m-b5" >
                        <i class="far fa-times-circle icon" onclick="roomOpen()"></i>
                    </div>
                    <div class="chat-room-menu-warp">
                        <i class="fas fa-bars icon" id="chat-room-menu-icon"></i>
                        <ul class="chat-room-menu shadow-all2">
                            <li>채팅방 초대</li>
                            <li onclick="modalRoomSetting()">채팅방 설정</li>
                            <hr class="m-tb5" />
                            <li onclick="roomExit(confirm('정말 나가시겠습니까?'))">채팅방 나가기</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- 채팅 -->
            <div class="chat-main">

                <div class="chat-container">
                    <div class="chat-icon">
                        <img src="images/free-icon-human-106137.png" alt="">
                    </div>
                    <div class="chat">
                        <div class="chat-name">
                            <h4>상대방</h4>
                        </div>
                        <div class="chat-content">
                            <div class="chat-text">
                                <span>채팅 내용 <br/> 채팅 내용ㅇㅁㄴㅇㄴㅁㅇㄴ</span>
                            </div>
                        </div>
                        <div class="chat-content">
                            <div class="chat-text">
                                <span>채팅 내용</span>
                            </div>
                            <div class="chat-info">
                                <span class="chat-count">1</span>
                                <span class="chat-time">오후 4:13</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-container my-chat">
                    <div class="chat">
                        <div class="chat-name">
                            <h4>자신</h4>
                        </div>
                        <div class="chat-content">
                            <div class="chat-text">
                                <span>채팅 내용 <br/> 채팅 내용ㅇㅁㄴㅇㄴㅁㅇㄴ</span>
                            </div>
                        </div>
                        <div class="chat-content">
                            <div class="chat-info">
                                <span class="chat-count">1</span>
                                <span class="chat-time">오후 4:13</span>
                            </div>
                            <div class="chat-text">
                                <span>채팅 내용</span>
                            </div>
                        </div>
                        <div class="chat-content">
                            <div class="chat-info">
                                <span class="chat-count">1</span>
                                <span class="chat-time">오후 4:13</span>
                            </div>
                            <div class="chat-text">
                                <span>채팅 내용</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- //채팅 -->
            <div class="chat-bottom">
                <div style="padding: 5px 5px;">
                    <textarea class="chat-send-text noto" name="messges" type="texta" id="message" autocomplete="off" ></textarea>
                    <input type="button" id="sendBtn" class="chat-send-btn"  value="전송" />
                </div>
                <div>
                    <i class="far fa-smile-beam icon"></i>
                    <i class="fas fa-paperclip icon"></i>
                </div>
            </div>
        </div>
    </div>
    <!-- //모달창 - 채팅방 -->

</body>

<script src="js/modal.js"></script>
<script>

    function chatScrollBottom() {
        $(".chat-main").scrollTop($(".chat-main")[0].scrollHeight);
    }

    function getRoomCode(btn) {
        $(btn).siblings("#room_code").val(Math.random().toString(36).substr(2,11));
    }

    function numberCircleZero() {

        var circle = $(".numberCircle span");

        for (let i = 0; i < circle.length; i++) {
            if ( $(circle[i]).html() == '') {
                $( circle[i] ).parent(".numberCircle").hide();
            }
        }
    }

    function noBubbling(event) {
        event.stopPropagation();
    }

    function logout(params) {
        if (params) {
            location.replace('logout');
        }
    }

    function roomOpen() {
        $(".chat-wrap").toggle();
    }


$(function () {
    numberCircleZero();
    chatScrollBottom();

    $(".list-icon-wrap").hover(function() {
        $(this).children(".list-icon-pop-text").toggle();
    });

    $("#upMember").submit(function () {
        alert("정보 수정으로 인해 로그아웃 됩니다.")
    });

    $("#join-form").submit(function (event) {

        event.preventDefault();
        roomPwdCheck(this);
    });

    $("#chat-room-menu-icon").click(function (event) {
        
        $(".chat-room-menu").toggle();
        event.stopPropagation();
    });

    $(document).click(function(){
        $(".chat-room-menu").hide();
    });

    $(".modal-box").draggable();
    $(".chat-wrap").draggable();
})

</script>

<script>

    function roomCodeCheck(room_code) {

        $.ajax({
			type 	: "POST",
            url 	: "/chatRoom/roomCodeCheck",
			data    : { room_code : room_code},
			success	: function( result ) {   
                
                if ( result != null) {

                    frm = $(join).find
                    
                    $.each(result, function (key, value) {
                        $("#join-form").find("#room_code").val(value.room_code);
                        $("#join-form").find("#room_title").val(value.room_title);
                        $("#join-form").find("#room_info").val(value.room_info);
                        
                        if (value.room_pwd != null ) {
                            $("#join-form").find("#join-pwd").show();
                            joinBtnToggle(false);
                        }else{
                            if ( $("#join-btn").hasClass("btn-off") ) joinBtnToggle(true);
                        }

                        modalJoin(true);
                    });
                }else {
                    alert("채팅방 코드가 틀렸습니다. 해당하는 방이 존재하지 않습니다");
                }
			},
			error	: function() {
                alert("error 관리자에게 문의 하십시오.");
			}
		});

    }

    function roomPwdCheck(btn) {

        var frm = $(btn).parents("form");

        $.ajax({
			type 	: "POST",
            url 	: "/chatRoom/roomCodeCheck",
            data    : { room_code   : frm.find("#room_code").val(),
                        room_pwd    : frm.find("#room_pwd").val() },
			success	: function( result ) {   
                
                if ( result != null) {
                    joinBtnToggle(true);
                    frm.find("#join-pwd").hide();
                }else {
                    alert("채팅방 비밀번호가 틀렸습니다.");
                }
			},
			error	: function() {
                alert("error 관리자에게 문의 하십시오.");
			}
		});
    }

</script>
<script>

    $("#sendBtn").click(function() {
        var sendData = { message : $(this).prev("textarea").val(), mem_id: '<%=(String)session.getAttribute("mem_id")%>' };
        alert( JSON.stringify(sendData));
		// sendMessage(JSON.stringify(sendData));
	});
	
	let sock = new SockJS("http://localhost:8080/simplechat/echo");
	sock.onmessage = onMessage;
	sock.onclose = onClose;
	// 메시지 전송
	function sendMessage(data) {
		sock.send(data);
	}
	// 서버로부터 메시지를 받았을 때
	function onMessage(msg) {
		var data = msg.data;
        
        if(data != null && data.trim() != '') {
            var jsonData = JSON.parse(data);

        }

	}
	// 서버와 연결을 끊었을 때
	function onClose(evt) {
		$("#messageArea").append("연결 끊김");
        //로그아웃
    }
</script>
</html>

